name: DOTDOTGOOSE

on:
  workflow_dispatch:
  
env:
    CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
    ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
    PST_KEY: ${{ secrets.PST_KEY }}
    PST_SECRET: ${{ secrets.PST_SECRET }}
    PST_TOKEN: ${{ secrets.PST_TOKEN }}
    PST_TOKEN_SECRET: ${{ secrets.PST_TOKEN_SECRET }}
    TELEGRAM: ${{ secrets.TELEGRAM }}
    CHAT_ID: ${{ secrets.CHAT_ID }}
    MASTODON: ${{ secrets.MASTODON }}
    
jobs:
  UPDATE-DOTDOTGOOSE:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - shell: pwsh
        name: Set choco key
        run: |
          choco apikey --key $env:CHOCO_API_KEY --source https://push.chocolatey.org/
          
      - name: DOTDOTGOOSE
        if: always()
        run:  |
          $Version = ([xml](Get-Content ./dotdotgoose/dotdotgoose.nuspec)).package.metadata.version
          Invoke-WebRequest -Uri "https://biodiversityinformatics.amnh.org/open_source/dotdotgoose/index.html" -OutFile "DDG.html"
          $Source = Get-Content -path DDG.html
          $Source -match '<ul class="local-list"> <li>[0-9]{4}-[0-9]{2}-[0-9]{2} - version ([0-9]+(\.[0-9]+)+) '
          $tag = $matches[1]
          
          echo $Version
          echo $tag
          
          if ( $tag -eq $Version )
          {
          echo 'Last version already exist'
          Remove-Item DDG.html
          }
          else
          {
          if ($tag -match '^[0-9]+.[0-9]+.[0-9]+$'){
          ./send_dotdotgoose.ps1
          Remove-Item DDG.html
          } else {
          echo 'The version number is not in the correct format'
          #exit 1
          }
          }
