name: TENACITY

on:
  #schedule:
  #  - cron:  '50 */6 * * *'
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - shell: pwsh
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          choco apikey --key $env:CHOCO_API_KEY --source https://push.chocolatey.org/
          
      - name: Chocolatey
        uses: crazy-max/ghaction-chocolatey@v1
        with:
          args: upgrade chocolatey

      - name: Script
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
          ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
          PST_KEY: ${{ secrets.PST_KEY }}
          PST_SECRET: ${{ secrets.PST_SECRET }}
          PST_TOKEN: ${{ secrets.PST_TOKEN }}
          PST_TOKEN_SECRET: ${{ secrets.PST_TOKEN_SECRET }}
        run:  |
          # $Version = ([xml](Get-Content ./tenacity/tenacity.nuspec)).package.metadata.version
          # $tag = (Invoke-WebRequest "https://api.github.com/repos/tenacityteam/tenacity/releases/latest" | ConvertFrom-Json)[0].tag_name
          #$tag = $tag -replace 'v'
          
          $tag = "0.1.0.001-alpha"
          
          #echo $Version
          #echo $tag
          #Start-Sleep -Seconds 5
          #if ( $tag -eq $Version )
          #{
          #echo 'Last version already exist'
          #}
          #else
          #{
          ./send_tenacity.ps1
          git config --local user.email "a-d-r-i@outlook.fr"
          git config --local user.name "A-d-r-i"
          git add .
          git commit -m "[Bot] Update files - Tenacity" --allow-empty
          git tag -a tenacity-v$tag -m "Tenacity - version $tag"
          git push -f && git push --tags
          $twitter = (Select-String -Path config.txt -Pattern "twitter=(.*)").Matches.Groups[1].Value
          if ( $twitter -eq "y" )
          {
          Install-Module PSTwitterAPI -Force
          Import-Module PSTwitterAPI
          $OAuthSettings = @{
          ApiKey = "${{ secrets.PST_KEY }}"
          ApiSecret = "${{ secrets.PST_SECRET }}"
          AccessToken = "${{ secrets.PST_TOKEN }}"
          AccessTokenSecret = "${{ secrets.PST_TOKEN_SECRET }}"
          }
          Set-TwitterOAuthSettings @OAuthSettings
          Send-TwitterStatuses_Update -status "Tenacity v$tag push now on @chocolateynuget! 
          
          Link: https://community.chocolatey.org/packages/tenacity/$tag
          @TenacityAudio
          #tenacity #release #opensource
          "
          }
          #}
